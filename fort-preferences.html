<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-ajax/iron-request.html">
<link rel="import" href="../fort-indexeddb-mirror/fort-indexeddb-mirror.html">
<link rel="import" href="../fort-behavior/fort-service-behavior.html">

<dom-module id="fort-preferences" attributes="name value cache">
  <template>
    <template is="dom-if" if="[[cache]]">
      <fort-indexeddb-mirror data="{{value}}" persisted-data="{{persistedValue}}"
                             key="[[name]]"></fort-indexeddb-mirror>
    </template>
  </template>
  <script>
    Polymer(
      {
        is:            'fort-preferences',
        behaviors:     [FortServiceBehavior],
        properties:    {
          gaid:  {type: String, readonly: true},
          name:  {type: String},
          value: {type: String, notify: true},
          cache: {type: Boolean},
          url:   {type: String, computed: '_computeUrl(name)', readonly: true}
        },
        _oldValue:     null,
        observers:     ['_valueChanged(value.*)'],
        _initialized:  false,
        _computeUrl:   function (name)
                       {
                         return '//' + this.getServiceHost('apps') + '/fortifi/preferences/'
                           + (this.gaid ? this.gaid + ':' : '') + name;
                       },
        ready:         function ()
                       {
                         var self = this, oReq = new XMLHttpRequest();
                         this.async(
                           function ()
                           {
                             oReq.addEventListener(
                               "load", function ()
                               {
                                 if(this.status == '200')
                                 {
                                   try
                                   {
                                     var response = JSON.parse(this.responseText);
                                     if(response.status == '200')
                                     {
                                       self.value = JSON.parse(response.value);
                                     }
                                     else
                                     {
                                       self.value = null;
                                     }
                                   }
                                   catch(e)
                                   {
                                     console.error(e);
                                   }
                                   finally
                                   {
                                     self._initialized = true;
                                   }
                                 }
                               }
                             );
                             oReq.open('GET', this.url, true);
                             oReq.send();
                           }
                         );
                       },
        _valueChanged: function ()
                       {
                         if(this._initialized)
                         {
                           var oReq = new XMLHttpRequest();
                           oReq.addEventListener(
                             "load", function ()
                             {
                               if(this.status == '200')
                               {
                                 var response = JSON.parse(this.responseText);
                                 if(response.status != '200')
                                 {
                                   console.error(this.statusText);
                                 }
                               }
                             }
                           );
                           oReq.open(this.value === undefined ? 'DELETE' : 'PUT', this.url, true);
                           oReq.send(this.value === undefined ? null : JSON.stringify(this.value));
                         }
                       }
      }
    );
  </script>
</dom-module>
